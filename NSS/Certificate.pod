=head1 NAME

NSS::Certificate - NSS Certificate functions

=head1 SYNOPSIS

  use 5.10.1;
  use Perl6::Slurp;

  use NSS;

  my $cert = NSS::Certificate->new(slurp('derfile'));

  say $cert->subject();
  say $cert->issuer();

  my $valid = $cert->validate_cert();
  
  if ( ! $cert->match_name('www.testdomain') ) {
    # Domain does not match certificate information
    exit(1);
  }

=head1 ABSTRACT

Perl interface for the certificate access parts of the NSS API.

=head1 DESCRIPTION

This class gives access to most of the certificate handling 
functions of NSS. For information on how to load and initialize the
NSS library, please refer to L<NSS>.

=head1 FUNCTIONS

=head2 CONSTRUCTORS

=over 4

=item new ( DERSTRING ) 

Creates a new NSS::Certificate object from the provided der-encoded
certificate string. 

The function croaks with the NSS error in case NSS cannot parse or
import the certificate

=item new_from_pem ( STRING )

Creates a new NSS::Certificate object from the pem-encoded certificate
string. Behaves exactly as new ( ).

=back 

=head2 ACCESSORS

=over 4

=item subject

Returns the certificate subject as string.

=item issuer

Returns the certificate issuer as string.

=item serial

Returns the hex-encoded serial number of the certificate.

=item notBefore

Returns the not before time as a string.

=item notAfter

Returns the notAfter tine as a string.

=item email

Returns the certificate email address (if present).

=item subj_alt_name 

Returns the certificate subject alternative name (if present).
May croak if the extension field in the certificate is invalud.

=item version

Returns the certificate version number.

=item common_name

Returns the most specific common name specified in the certificate
subject.

=item is_root

Returns true if NSS thinks that the certificate is a root (selfsigned)
certificate and false otherwise.

=item sig_alg_name

Returns the name of the signature algorithm.

=item key_alg_name

Returns the name of the encryption algorithm.

=back

=head2 VERIFICATION FUNCTIONS

These functions allow verification of certificate chains. Please note that
for most of them a database has to be used and a root-certificate list has
to be loaded. See L<NSS>.

There are several diffferent verification functions, because the NSS
library offers a variety of methods to validate certificates. You probably
want to either use C<verify_certificate> or C<verify_pkix>.

=over 4

=item match_name ( HOSTNAME ) 

Return true is NSS considers the hostname to be valid for the certificate.
Returns false otherwise.

=item verify_certificate( [TIME], [USAGE] )

Returns 1 if the certificate can be validated up to a root-certificate.
Otherwise returns the numeric NSS error code. Time can contain the unix
timestamp of the verification time. Usage can contain a the certificate
usage - usualle certUsageSSLServer is assumed.

This is (basically) the verification function that is used by firefox
at the moment (they add a few more special checks in the firefox codebase).

=item verify_cert ( [TIME], [USAGE] )

Same as C<verify_certificate>, just using the verify_cert NSS function
instead of the verify_certificate NSS function.

=item verify_certificate_pkix( [TIME], [USAGE] )

Same as C<verify_certificate>, just using the PKIX library for validation by
using CERT_SetUsePKIXForValidation.

=item verify_certificate_log( [TIME], [USAGE] )

Same verification as in C<verify_certificate>; however this function returns
an empty list in case of success. In case of error, a list of hashes is returned.
The hash contains the certificate that generated the error and the error code.

This allows to see which certificate in a certificate chain was responsible
for preventing the validation of the chain. If several errors occur, the list
may contain several hashes with differing error codes.

=item verify_certificate_pkix_log( [TIME], [USAGE] )

Like verify_certificate_log, just using the PKIX library for validation by
using CERT_SetUsePKIXForValidation.

=item verify_cert_log ( [TIME], [USAGE] )

Same as C<verify_certificate_log>, just using the verify_cert NSS function
instead of the verify_certificate NSS function.

=item verify_pkix ( [TIME], [USAGE], [TRUSTED CERT LIST )

Returns 1 if the certificate can be validated up to a root-certificate using
the CERT_PKIXVerifyCert function. Otherwise returns the numeric NSS error code.
This function is (basically) used by Chrome to validate certificates.

Trusted cert list can contain a L<NSS::CertList>, of trusted certificates.
Please note that it is not a good idea to just load all root-certificates into 
a NSS::CertList and try to validate using this function, without using a NSS
database backend; chain validation does not work correctly in that case.

=item get_cert_chain_from_cert( [TIME], [USAGE] ) 

Get a L<NSS::CertList> containing the certificate chain up to a root-certificate
for the current certificate.

=back


=head1 AUTHOR

Johanna Amann, E<lt>johanna@icir.orgE<gt>

=head1 COPYRIGHT AND LICENSE

Copyright 2012 by Johanna Amann

This library is free software and licensed under the GNU LGPL, version 2.1
as available at http://www.gnu.org/licenses/lgpl-2.1.html.

The library contains source code of the Mozilla Network Security Services; for
NSS license information please see http://www.mozilla.org/projects/security/pki/nss/.

=cut

